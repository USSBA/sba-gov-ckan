{
  "variables": {
    "image_name": "ussba-cis-centos7-ckan-test",
    "ckan_version": "2.8.2"
  },
  "builders": [{
    "type": "amazon-ebs",
    "name": "cis-ckan",
    "region": "us-east-1",
    "instance_type": "t2.medium",
    "ssh_username": "centos",
    "ssh_interface": "public_ip",
    "ami_name": "{{user `image_name`}}-{{timestamp}}",
    "tags": {
        "Name": "packer-{{user `image_name`}}-{{timestamp}}"
    },
    "snapshot_tags": {
        "Name": "packer-{{user `image_name`}}-{{timestamp}}"
    },
    "run_tags": {
        "Name": "packer-{{user `image_name`}}-{{timestamp}}"
    },
    "source_ami_filter": {
      "filters": {
        "virtualization-type": "hvm",
        "name": "CIS Centos Linux 7 Benchmark*",
        "root-device-type": "ebs"
      },
      "owners": ["679593333241"],
      "most_recent": true
    }
  }
  ],
  "provisioners": [
      {
        "type": "shell",
        "inline":[
            "echo 'Installing EPEL for dependency resolution'",
            "sudo yum install -y https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm",
            "echo 'performing yum updates'",
            "sudo yum update -y",
            "echo 'Installing pip and aws-cli...'",
            "sudo yum install -y python-pip",
            "sudo pip install awscli",
            "sudo /usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz"
        ]
      },
      {
        "type": "shell",
        "inline": [
            "echo 'Installing CKAN base dependencies: Virtualenv, Postgres, Git, Java 8...'",
            "sudo yum install -y python-virtualenv",
            "echo 'virtualenv --version'",
            "sudo yum install -y postgresql",
            "echo 'postgresql --version'",
            "sudo yum install -y git",
            "echo 'git --version'",
            "sudo yum install -y java-1.8.0-openjdk"
            ]
      },
      {
        "type": "shell",
        "inline": [
            "echo 'Installing CKAN v{{user `ckan_version`}} inside of virtual environment...'",
            "sudo mkdir -p /usr/lib/ckan/default",
            "sudo chown `whoami` /usr/lib/ckan/default",
            "sudo virtualenv --no-site-packages /usr/lib/ckan/default",
            ". /usr/lib/ckan/default/bin/activate",
            "sudo pip install setuptools==36.1",
            "sudo pip install -e 'git+https://github.com/ckan/ckan.git@ckan-{{user `ckan_version`}}#egg=ckan'",
            "sudo pip install -r ~/src/ckan/requirements.txt"]
      },
      {
        "type": "shell",
        "inline": [
            "echo 'Installing CKAN search dependencies: Jetty, SOLR, Redis...'",
            "cd /opt/",
            "sudo curl -O https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-distribution/9.4.15.v20190215/jetty-distribution-9.4.15.v20190215.tar.gz",
            "sudo tar -xzvf jetty-distribution-9.4.15.v20190215.tar.gz -C /opt/",
            "sudo mv jetty-distribution-9.4.15.v20190215 jetty",
            "sudo ln -s /opt/jetty/bin/jetty.sh /etc/init.d/jetty",
            "sudo rm jetty-distribution-9.4.15.v20190215.tar.gz",
            "sudo curl -O https://archive.apache.org/dist/lucene/solr/8.0.0/solr-8.0.0.tgz",
            "sudo tar -xzf solr-8.0.0.tgz -C /opt/",
            "sudo mv solr-8.0.0 solr",
            "sudo ln -s solr-8.0.0 solr",
            "sudo rm solr-8.0.0.tgz",
            "sudo yum install -y redis",
            "cd ~"
        ]
      },
      {
        "type": "shell",
        "inline": [
            "echo 'Setting up PostgresSQL..."
        ]
      },
      {
        "type": "shell",
        "inline": [
            "echo 'Creating CKAN configuration files...'",
            "sudo mkdir -p /etc/ckan/default",
            "sudo chown -R `whoami` /etc/ckan/",
            "sudo chown -R `whoami` ~/ckan/etc",
            "paster make-config ckan /etc/ckan/default/development.ini"
            ]
      }
    ]
}